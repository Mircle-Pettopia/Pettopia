<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{../templates/layout}">

<head>

  <title>Shoping Cart</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

</head>


<div layout:fragment="content">

  <!-- Cart -->

  <body>
    <div class="wrap-header-cart js-panel-cart">
      <div class="s-full js-hide-cart"></div>
      <div class="header-cart flex-col-l p-l-65 p-r-25">
        <div class="header-cart-title flex-w flex-sb-m p-b-8">
          <span class="mtext-103 cl2"> Your Cart </span>

          <div class="fs-35 lh-10 cl2 p-lr-5 pointer hov-cl1 trans-04 js-hide-cart">
            <i class="zmdi zmdi-close"></i>
          </div>
        </div>

        <div class="header-cart-content flex-w js-pscroll">
          <ul class="header-cart-wrapitem w-full">
            <li class="header-cart-item flex-w flex-t m-b-12">
              <div class="header-cart-item-img">
                <img src="images/item-cart-01.jpg" alt="IMG" />
              </div>

              <div class="header-cart-item-txt p-t-8">
                <a href="#" class="header-cart-item-name m-b-18 hov-cl1 trans-04">
                  test test test 안팔아요
                </a>

                <span class="header-cart-item-info">xxxx </span>
              </div>
            </li>

            <li class="header-cart-item flex-w flex-t m-b-12">
              <div class="header-cart-item-img">
                <img src="images/item-cart-02.jpg" alt="IMG" />
              </div>

              <div class="header-cart-item-txt p-t-8">
                <a href="#" class="header-cart-item-name m-b-18 hov-cl1 trans-04">
                  Converse All Star
                </a>

                <span class="header-cart-item-info"> 1 x $39.00 </span>
              </div>
            </li>

            <li class="header-cart-item flex-w flex-t m-b-12">
              <div class="header-cart-item-img">
                <img src="images/item-cart-03.jpg" alt="IMG" />
              </div>

              <div class="header-cart-item-txt p-t-8">
                <a href="#" class="header-cart-item-name m-b-18 hov-cl1 trans-04">
                  Nixon Porter Leather
                </a>

                <span class="header-cart-item-info"> 1 x $17.00 </span>
              </div>
            </li>
          </ul>

          <div class="w-full">
            <div class="header-cart-total w-full p-tb-40">Total: $75.00</div>

            <div class="header-cart-buttons flex-w w-full">
              <a href="shoping-cart.html"
                class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-r-8 m-b-10">
                View Cart
              </a>

              <a href="shoping-cart.html"
                class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-b-10">
                Check Out
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- breadcrumb -->
    <div class="container">
      <div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
        <a href="index.html" class="stext-109 cl8 hov-cl1 trans-04">
          Home
          <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
        </a>

        <span class="stext-109 cl4"> 장바구니 </span>
      </div>
    </div>

    <!-- Shoping Cart -->
    <form class="bg0 p-t-75 p-b-85" onSubmit="return false;">
      <div class="container">
        <div class="row">
          <div class="col-lg-10 col-xl-8 m-lr-auto m-b-50">
            <div class="m-l-25 m-r--38 m-lr-0-xl">
              <div class="wrap-table-shopping-cart">
                <table class="table-shopping-cart" id="cart-table">
                  <tbody id="cartList">

                  </tbody>
                </table>
              </div>

              <!-- <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">
                <div class="flex-w flex-m m-r-20 m-tb-5">
                  <input class="stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" type="text" name="coupon"
                    placeholder="적립금" />

                  <div class="flex-c-m stext-101 cl2 size-118 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-5">
                    적립금
                  </div>
                </div>

                <div class="flex-c-m stext-101 cl2 size-119 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-10">
                  Update Cart
                </div>
              </div> -->
            </div>
          </div>

          <div class="col-sm-10 col-lg-7 col-xl-4 m-lr-auto m-b-50">
            <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
              <h4 class="mtext-109 cl2 p-b-30">Cart Totals</h4>

              <div class="flex-w flex-t  p-b-13">
                <div class="size-208">
                  <span class="stext-110 cl2"> 상품 합계:</span>
                </div>

                <div class="size-209">
                  <span class="mtext-110 cl2" id="sumPrice"> </span><span class="mtext-110 cl2">원</span>
                </div>
              </div>

              <div class=" flex-w flex-t bor12 p-b-13">
                <div class="size-208">
                  <span class="stext-110 cl2"> 배송비: </span>
                </div>

                <div class="size-209">
                  <span class="mtext-110 cl2" id="shipPrice"> 2500 </span><span class="mtext-110 cl2">원</span>
                </div>
              </div>


              <div class="flex-w flex-t p-t-27 p-b-33">
                <div class="size-208">
                  <span class="mtext-101 cl2"> 총금액: </span>
                </div>

                <div class="size-209 p-t-1">
                  <span class="mtext-110 cl2" id="FinalPrice"> </span><span class="mtext-110 cl2">원</span>
                </div>
              </div>

              <button class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer"
                onclick="toOrder()">
                구매하기
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!--Back to top-->
    <div class="btn-back-to-top" id="myBtn">
      <span class="symbol-btn-back-to-top">
        <i class="zmdi zmdi-chevron-up"></i>
      </span>
    </div>

    <!--test============================ -->
    <script src="vendor/jquery/jquery-3.2.1.min.js"></script>

    <script>



      function toOrder() {
        location.href = "OrderMain";
      }

      function GetUser() {
        let result = "";
        $.ajax({
          url: "getUser",
          method: "GET",
          async: false,
          success: function (data) {
            console.log(data);
            result = data;
          },
          error: function (reject) {
            console.log(reject);
            console.log("카트불러오기실패");
          },
        })
        return result;
      }


      getCart()
      function getCart() {
        let result = "";
        $.ajax({
          url: "getCart",
          method: "GET",
          async: false,
          data: { meId: GetUser() },
          success: function (data) {
            console.log(data);
            console.log('장바구니 목록 불러오기성공');
            drawCart(data);
          },
          error: function (reject) {
            console.log(reject);
            console.log("비로그인");
          },
        })
      }

      function setAmount(crtId, amount) {
        $.ajax({
          url: "setAmount",
          method: "Post",
          async: false,
          dataType: "json",
          data: { crtId: crtId, cnt: amount },
          success: function (data) {
            console.log(data + '갯수 업데이트됨');
          },
          error: function (reject) {
            console.log(reject);
          },
        })
      }

      function deleteCart(crtId) {
        $.ajax({
          url: "delCart",
          method: "delete",
          async: false,
          dataType: "json",
          data: { crtId: crtId },
          success: function (data) {
            console.log(data + '장바구니 삭제됨');
            getCart();
          },
          error: function (reject) {
            console.log(reject);
          },
        })
      }

      function drawCart(data) {
        //헤더넣기
        cartList.innerHTML = `
        
        <tr class="table_head">
                      <th class="column-1"></th>
                      <th class="column-2">상품명</th>
                      <th class="column-3">가격</th>
                      <th class="column-4">수량</th>
                      <th class="column-5">총가격</th>
                      <th class="column-6">제거</th>
                    </tr>
        `;
        let prodOverlapKey = '';
        //라인넣기
        for (let i = 0; i < data.length; i++) {
          if (prodOverlapKey != data[i].crtId) {
            console.log("drawing overlap")
            prodOverlapKey = data[i].crtId;
            cartList.innerHTML +=
              `
            <tr class="table_row" id="data[i].crtId">
              <td class="column-1">
                <div class="how-itemcart1">
                  <img src="download/${data[i].prdtImg}" alt="IMG" />
                </div>
              </td>

              <td class="column-2">${data[i].prdtNm}<hr><span id="${data[i].crtId}Options"></span></td>
              <td class="column-3"><span id = "${data[i].crtId}Price">${data[i].prdtPrc}</span><span>원</span></td>
              <td class="column-4">
                <div class="px-1 py-1 flex-w mx-auto">
                  <div class="border cl8 hov-btn3 trans-04 flex-c-m px-4" onclick="counter('-','${data[i].crtId}','CNT')">
                    -
                  </div>
                  <div class="border px-4  py-3" id=${data[i].crtId}CNT>${data[i].cnt}</div>
                  <div class="border cl8 hov-btn3 trans-04 flex-c-m px-4" onclick="counter('+','${data[i].crtId}','CNT')">
                    +
                  </div>
                </div>
              </td>
              <td class="column-5" ><span class="prdtTotal" id="${data[i].crtId}Total"></span>원</td>
              <td class="column-6 row-del-btn"><button onclick="deleteCart('${data[i].crtId}')">X</button></td>
            </tr>
          `
          }
          DomId(data[i].crtId + "Options").innerHTML += (data[i].optDetaNm == null ? "" : ("[" + data[i].optDetaNm + "] "));
          DomId(data[i].crtId + "Price").innerText = DomId(data[i].crtId + "Price").innerText * 1 + data[i].addPrc * 1;
          comPrdtTotal(data[i].crtId);
        }
        if (data.length == 0) {
          cartList.innerHTML = `<h2>장바구니에 상품이 없습니다</h2>`
        }
      }


      function DomId(id) { //id로 태그찾기 압축용
        return document.getElementById(id)
      }


      function counter(UD, target, suf) {
        if (UD == '+') {
          DomId(target + suf).innerText = (DomId(target + suf).innerText) * 1 + 1
        }
        else if (UD == '-' && DomId(target + suf).innerText > 1) {
          DomId(target + suf).innerText = DomId(target + suf).innerText * 1 - 1
        }
        comPrdtTotal(target)
        setAmount(target, DomId(target + suf).innerText);
      }


      function comPrdtTotal(target) {
        DomId(target + 'Total').innerText = DomId(target + 'Price').innerText * DomId(target + 'CNT').innerText;
        let prdtTotalElements = document.getElementsByClassName('prdtTotal');
        sumPrice.innerText = '0'
        for (let i = 0; i < prdtTotalElements.length; i++) {
          sumPrice.innerText = (sumPrice.innerText * 1) + (prdtTotalElements[i].innerText * 1);
        }
        FinalPrice.innerText = sumPrice.innerText * 1 + shipPrice.innerText * 1;
      }
    </script>
    <!--test============================= -->

</div>


</body>

</html>